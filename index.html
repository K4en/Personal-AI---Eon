<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Eon - AI</title>
</head>
<body>
    <h2>Eon - AI Assistant</h2>
    //Select AI model
    <label for="task"></label>
    <select id="task">
        <option value="llama3">Chat(LLaMA3)</option>
        <option value="mistral">Mistral</option>
        <option value="gemma">Code</option>
    </select>
    <br><br>

    <label for="prompt"></label>
    <input type="text" id="prompt" placeholder="Please type your question.."/>

    <button id="askBtn">Ask</button>
    <button id="voiceBtn">Speak</button>

    <h3>Response:</h3>
    <div id="response"></div>

    <h3>History:</h3>
    <div id="history"></div>

    <h3>Memory:</h3>
    <div id="memory"></div>
    <form id="memoryForm">
        <label>Name: <input type="text" id="user_name"/></label><br>
        <label>Location: <input type="text" id="location"/></label><br>
        <label>Likes (comma-separated): <input type="text" id="likes"/></label><br>
        <button type="submit">Update Memory</button>
    </form>

    <h3>Knowledge:</h3>
    <div id="knowledge"></div>
    <label for="tagFilter">Filter by tag:</label>
    <input type="text" id="tagFilter" placeholder="e.g coding, biology"/>
    <button onclick="fetchAndRenderKnowledge()">Apply Filter</button>

    <script>
        const askBtn = document.getElementById("askBtn");
        const voiceBtn = document.getElementById("voiceBtn");

        const modelSelect = document.getElementById("task");
        const promptInput = document.getElementById("prompt");
        const responseDiv = document.getElementById("response");
        const historyDiv = document.getElementById("history")

        //Text to speech
        function speak(text){
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        }

        //Send prompt to Flask server
        async function askAssistant(){
            const prompt = promptInput.value;
            const task = modelSelect.value;

            const response = await fetch("http://192.168.1.249:5000/ask",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({prompt:prompt, task:task})
            });

            const data = await response.json();
            const reply = data.response;

            responseDiv.textContent = reply;
            speak(reply);

            await fetchAndRenderHistory();
        }

        //Button to send typed question
        askBtn.onClick = askAssistant;

        //Voice recognition
        const recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = "en-US";
        recognition.interimResults = false;

        voiceBtn.onclick = () =>{
            recognition.start();
        };

        recognition.onresult = (event) =>{

            promptInput.value = event.results[0][0].transcript;
            askAssistant();
        };

        recognition.onerror = (event) =>{
            alert("Speech recognition error:"+event.error);
        };

        // Fetch and display chat history
        async function fetchAndRenderHistory(){
            const res = await fetch("http://192.168.1.249:5000/history");
            const history = await res.json()

            historyDiv.innerHTML = "";
            history.forEach(entry => {
                historyDiv.innerHTML += `
                    <div style = "margin-bottom: 1em;">
                        <strong>ðŸ•’${entry.timestamp}</strong><br/>
                        <strong>You:</strong> ${entry.prompt}<br/>
                        <strong>AI:</strong> ${entry.response}<br/>
                        <em>Model: ${entry.task}</em>
                    </div>
            `;

            })
        }

        // Fetch and render memory

        async function fetchAndRenderMemory(){
            const res = await fetch("http://192.168.1.249:5000/memory");
            const memory = await res.json();

            const memoryDiv = document.getElementById("memory");
            memoryDiv.innerHTML = "<pre>" + JSON.stringify(memory, null, 2) + "</pre>";
        }

        async function loadMemoryIntoForm(){
            const res = await fetch("http://192.168.1.249:5000/memory");
            const memory = await res.json();

            document.getElementById("user_name").value = memory.user_name?.value || "";
            document.getElementById("location").value = memory.location?.value || "";
            document.getElementById("likes").value = (memory.likes?.value || []).join(", ");
        }

        document.getElementById("memoryForm").onsubmit = async (e) =>{
            e.preventDefault()
            const user_name = document.getElementById("userName").value.trim();
            const location = document.getElementById("location").value.trim();
            const likes = document.getElementById("likes").value.trim();

            const updateMemory = {
                user_name: {value: user_name, type: "identity"},
                location: {value: location, type: "preference"},
                likes: {value: likes.split(",").map(1=>1.trim()), type: "interest"}
            };

            await fetch("http://192.168.1.249:5000/memory",{
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(updateMemory)
            });

            await fetchAndRenderMemory();
            alert("Memory updated!")
        }

        // Fetch and render Knowledge

        async function fetchAndRenderKnowledge(){
            const res = await fetch("http://192.168.1.249:5000/knowledge");
            const knowledge = await res.json();

            const filterTags = document.getElementById("tagFilter").value
                .split(",")
                .map(tag=>tag.trim().toLowerCase())
                .filter(tag=>tag);

            const knowledgeDiv = document.getElementById("knowledge");
            knowledgeDiv.innerHTML = "";

            const filtered = filterTags.length === 0
                ? knowledge
                : knowledge.filter(chunk=>{
                    const chunkTags = (chunk.tags||[]).map(t=> t.toLowerCase());
                    return filterTags.some(tag => chunkTags.includes(tag));
                })

            if (filtered.length === 0){
                knowledgeDiv.innerHTML = "<em>No knowledge loaded.</em>";
                return;
            }

            filtered.forEach((chunk, index) => {
                const container = document.createElement("div");
                const tagStr = (chunk.tags||[]).join(", ");
                const content = chunk.content||chunk; //fallback for legacy format

                container.innerHTML =`
                    <textarea id="chunk-${index}" rows="3" style="width:100%;">${content}</textarea>
                    <label>Tags:</label>
                    <input type="text" id="tags-${index}" value="${tagStr}" style="width:100%"></br>
                    <button onclick="updateChunk(${index})">ðŸ’¾ Save</button>
                    <button onclick="deleteChunk(${index})">ðŸ—‘ Delete</button>
                    </hr>
                `;
                knowledgeDiv.appendChild(container);
            });
        }

        // Update Knowledge Chunks

        async function updateChunk(index){
            const content = document.getElementById(`chunk-${index}`).value;
            const tags = document.getElementById(`tags-${index}`).value
                .split(",")
                .map(tag=>tag.trim())
                .filter(tag=>tag);

            await fetch(`http://192.168.1.249:5000/knowledge/${index}`,{
                method:"PUT",
                headers:{"Content-Type": "application/json"},
                body: JSON.stringify({content, tags})
            });
            await fetchAndRenderKnowledge();
        }

        // Delete Knowledge Chunks

        async function deleteChunk(index){
            await fetch(`http://192.168.1.249:5000/knowledge/${index}`,{
                method: "DELETE"
            });
            await fetchAndRenderKnowledge();
        }

        fetchAndRenderHistory();
        fetchAndRenderMemory();
        fetchAndRenderKnowledge();
        loadMemoryIntoForm();
    </script>
</body>
</html>